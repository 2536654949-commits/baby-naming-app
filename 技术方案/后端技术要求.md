# 宝宝起名应用 - 后端实现方案
> 本文档详细描述后端架构、技术选型、API 设计和 Supabase 配置信息
>
> **文档版本：** v2.0.0
> **最后更新：** 2026-01-23
> **更新内容：** 修复授权码格式、一客一码机制、Token恢复、频率限制、收藏同步

---

## 一、技术栈
### 核心框架
| 技术 | 版本 | 用途 |
| --- | --- | --- |
| **Node.js** | - | 运行时环境 |
| **TypeScript** | ^5.3.0 | 类型安全开发 |
| **Express.js** | ^5.0.0 | Web 框架 |
| **Prisma** | ^5.0.0 | ORM 数据访问 |


### 数据库与 AI
| 服务 | 用途 |
| --- | --- |
| **Supabase PostgreSQL** | 主数据库 |
| **Redis** | 频率限制缓存（可选） |
| **智谱 AI (GLM-4.7)** | 名字生成 AI 服务 |


### 安全与认证
| 技术 | 用途 |
| --- | --- |
| **JWT** | 令牌认证 |
| **bcrypt** | 密码加密 |
| **Helmet** | 安全头部 |
| **CORS** | 跨域控制 |


### 中间件与工具
| 技术 | 用途 |
| --- | --- |
| **express-rate-limit** | 请求限流 |
| **Winston** | 日志管理 |
| **Zod** | 数据验证 |
| **compression** | 响应压缩 |
| **axios** | HTTP 客户端 |


---

## 二、项目结构
```plain
backend/
├── prisma/
│   └── schema.prisma          # Prisma 数据模型定义
│
├── src/
│   ├── app.ts                 # Express 应用配置
│   ├── server.ts              # 服务器入口（启动、优雅关闭）
│   │
│   ├── config/                # 配置模块
│   │   ├── database.ts        # Prisma 客户端实例
│   │   ├── jwt.ts             # JWT 配置
│   │   └── index.ts           # 统一导出
│   │
│   ├── controllers/           # 控制器层（请求/响应处理）
│   │   ├── auth.controller.ts # 认证控制器
│   │   ├── name.controller.ts # 起名控制器
│   │   ├── favorite.controller.ts # 收藏控制器
│   │   ├── health.controller.ts # 健康检查
│   │   └── index.ts           # 统一导出
│   │
│   ├── services/              # 业务逻辑层
│   │   ├── auth.service.ts    # 认证服务（授权码验证、Token）
│   │   ├── name.service.ts    # 起名服务（编排）
│   │   ├── favorite.service.ts # 收藏服务（云端同步）
│   │   ├── zhipu.service.ts   # 智谱 AI 调用服务
│   │   ├── jwt.service.ts     # JWT 生成/验证
│   │   ├── code.service.ts    # 授权码业务逻辑
│   │   ├── rate-limit.service.ts # 频率限制服务（基于用户ID）
│   │   └── index.ts           # 统一导出
│   │
│   ├── repositories/          # 数据访问层（Prisma 封装）
│   │   ├── code.repository.ts # 授权码 CRUD
│   │   ├── usage.repository.ts # 使用记录 CRUD
│   │   ├── favorite.repository.ts # 收藏 CRUD
│   │   ├── admin.repository.ts # 管理员 CRUD
│   │   └── index.ts           # 统一导出
│   │
│   ├── middleware/            # 中间件
│   │   ├── auth.middleware.ts # JWT 认证
│   │   ├── validate.middleware.ts # Zod 数据验证
│   │   ├── rate-limit.middleware.ts # 限流控制
│   │   ├── error.middleware.ts # 全局错误处理
│   │   ├── logger.middleware.ts # 请求日志
│   │   └── index.ts           # 统一导出
│   │
│   ├── routes/                # 路由定义
│   │   ├── auth.routes.ts     # 认证路由
│   │   ├── name.routes.ts     # 起名路由
│   │   ├── favorite.routes.ts # 收藏路由
│   │   ├── health.routes.ts   # 健康检查路由
│   │   └── index.ts           # 路由聚合
│   │
│   ├── types/                 # TypeScript 类型定义
│   │   ├── auth.types.ts      # 认证类型
│   │   ├── name.types.ts      # 起名类型
│   │   ├── zhipu.types.ts     # 智谱 AI 类型
│   │   ├── api.types.ts       # API 类型
│   │   ├── express.d.ts       # Express 扩展类型
│   │   └── index.ts           # 统一导出
│   │
│   └── utils/                 # 工具函数
│       ├── logger.ts          # Winston 日志配置
│       ├── error.ts           # ApiError 自定义错误类
│       ├── crypto.ts          # 加密工具
│       ├── response.ts        # 响应格式化
│       ├── mask.ts            # 数据脱敏
│       └── index.ts           # 统一导出
│
├── .env                       # 环境变量（本地开发）
├── .env.example               # 环境变量示例
├── package.json               # 项目配置
├── tsconfig.json              # TypeScript 配置
└── nodemon.json               # 开发热重载配置
```

---

## 三、架构设计
### 3.1 分层架构
```plain
┌─────────────────────────────────────────────────────────────┐
│                         Client                               │
│                    (前端 / 移动端)                           │
└─────────────────────────────┬───────────────────────────────┘
                              │ HTTP/HTTPS
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Middleware Layer                        │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────┐  │
│  │   CORS   │ │  Helmet  │ │  Logger  │ │ Rate Limit   │  │
│  └──────────┘ └──────────┘ └──────────┘ └──────────────┘  │
└─────────────────────────────┬───────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       Routes Layer                           │
│  ┌──────────────────┐      ┌──────────────────┐            │
│  │   /api/auth      │      │   /api/name      │            │
│  │   /api/health    │      │                  │            │
│  └──────────────────┘      └──────────────────┘            │
└─────────────────────────────┬───────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Middleware Chain                          │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────┐  │
│  │ Validate │ │  Auth    │ │  Error   │ │  Not Found   │  │
│  └──────────┘ └──────────┘ └──────────┘ └──────────────┘  │
└─────────────────────────────┬───────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Controllers Layer                         │
│  ┌──────────────────┐      ┌──────────────────┐            │
│  │  AuthController  │      │ NameController   │            │
│  └──────────────────┘      └──────────────────┘            │
└─────────────────────────────┬───────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     Services Layer                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ AuthService  │  │ NameService  │  │ ZhipuService │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│  ┌──────────────┐  ┌──────────────┐                        │
│  │ JwtService   │  │ CodeService  │                        │
│  └──────────────┘  └──────────────┘                        │
└─────────────────────────────┬───────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  Repositories Layer                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │CodeRepository│  │UsageRepository│ │AdminRepository│     │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────┬───────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       Prisma ORM                             │
│                     (Type Safe Query)                        │
└─────────────────────────────┬───────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Supabase PostgreSQL                       │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 请求处理流程
```plain
用户请求
    │
    ▼
┌─────────────────┐
│  安全中间件      │ ← Helmet（安全头部）、CORS
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  日志中间件      │ ← Winston 请求日志
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  限流中间件      │ ← express-rate-limit
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  验证中间件      │ ← Zod Schema 验证
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  认证中间件      │ ← JWT 令牌验证（如需要）
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   控制器        │ ← 处理请求/响应
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   服务层        │ ← 业务逻辑编排
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  数据访问层      │ ← Prisma 数据库操作
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   数据库        │ ← Supabase PostgreSQL
└─────────────────┘
```

---

## 四、数据库设计
### 4.1 数据模型 (Prisma Schema)
```plain
// 授权码表 - 一客一码机制
model AuthorizationCode {
  id          Int      @id @default(autoincrement())
  code        String   @unique              // 授权码（格式：BABY-XXXX-XXXX-XXXX-XXXX，16位）
  status      String   @default("UNUSED")   // 状态: UNUSED(未使用)/USED(已使用)/EXPIRED(已过期)
  deviceId    String?                       // 绑定设备指纹（User-Agent + IP的SHA256）
  activatedAt DateTime?                     // 激活时间
  activatedIp String?                       // 激活IP（安全审计）
  expiresAt   DateTime?                     // 未激活授权码90天过期（createdAt + 90天）
  batchId     String?                       // 批次 ID
  metadata    String?                       // 元数据 (JSON)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  usageRecords UsageRecord[]

  @@index([status])
  @@index([deviceId])
  @@index([batchId])
  @@map("authorization_code")
}

// 使用记录表
model UsageRecord {
  id             Int      @id @default(autoincrement())
  codeId         Int                        // 关联授权码
  code           String                     // 授权码
  userId         String                     // 用户ID（从JWT解析）
  deviceId       String                     // 设备 ID
  babyInfo       Json                       // 宝宝信息 (JSON)
  aiResult       Json                       // AI 生成结果 (JSON)
  generationTime Int?                       // 生成耗时 (ms)
  createdAt      DateTime @default(now())

  authorizationCode AuthorizationCode @relation(fields: [codeId], references: [id])

  @@index([codeId])
  @@index([userId])
  @@index([deviceId])
  @@index([createdAt])
  @@map("usage_record")
}

// 收藏表 - 云端同步
model Favorite {
  id        BigInt   @id @default(autoincrement())
  userId    String                        // 用户ID（从JWT解析）
  nameData  Json                          // 完整名字数据（与前端类型定义一致）
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, nameId], name: "user_name_unique") // 防止重复收藏
  @@index([userId])
  @@index([createdAt])
  @@map("favorites")
}

// 管理员表
model AdminUser {
  id           Int       @id @default(autoincrement())
  username     String    @unique
  passwordHash String    @map("password_hash")
  role         String    @default("ADMIN")
  email        String?   @unique
  lastLoginAt  DateTime? @map("last_login_at")
  lastLoginIp  String?   @map("last_login_ip")
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@index([isActive])
  @@map("admin_user")
}

// 埋点事件表
model AnalyticsEvent {
  id        BigInt   @id @default(autoincrement())
  eventName String   @map("event_name")
  deviceId  String?
  sessionId String?  @map("session_id")
  codeId    Int?     @map("code_id")
  properties String? // JSON 字符串
  createdAt DateTime @default(now()) @map("created_at")

  @@index([eventName])
  @@index([deviceId])
  @@index([createdAt])
  @@map("analytics_event")
}
```

### 4.2 表关系图
```plain
┌─────────────────────┐         ┌─────────────────────┐
│ AuthorizationCode   │ 1     N │   UsageRecord       │
├─────────────────────┤─────────├─────────────────────┤
│ id (PK)             │         │ id (PK)             │
│ code (16位)         │         │ codeId (FK)         │
│ status              │         │ userId              │
│ deviceId            │         │ deviceId            │
│ activatedAt         │         │ babyInfo (JSON)     │
│ activatedIp         │         │ aiResult (JSON)     │
│ expiresAt           │         │ generationTime      │
│ createdAt           │         │ createdAt           │
└─────────────────────┘         └─────────────────────┘

┌─────────────────────┐
│      Favorite       │ (云端同步)
├─────────────────────┤
│ id (PK)             │
│ userId              │
│ nameData (JSON)     │
│ createdAt           │
│ updatedAt           │
└─────────────────────┘

┌─────────────────────┐
│     AdminUser       │
├─────────────────────┤
│ id (PK)             │
│ username            │
│ passwordHash        │
│ role                │
│ email               │
│ isActive            │
└─────────────────────┘

┌─────────────────────┐
│   AnalyticsEvent    │
├─────────────────────┤
│ id (PK)             │
│ eventName           │
│ deviceId            │
│ sessionId           │
│ codeId (FK)         │
│ properties (JSON)   │
│ createdAt           │
└─────────────────────┘
```

### 4.3 核心业务规则
**一客一码机制**：
- 授权码格式：`BABY-XXXX-XXXX-XXXX-XXXX`（16位）
- 未激活授权码90天过期
- 激活后状态变为USED，授权码永久有效
- 激活后绑定设备指纹（User-Agent + IP的SHA256）

**Token恢复机制**：
- 用户清除浏览器数据后，可使用原授权码重新激活
- 系统验证设备指纹，匹配则恢复Token
- 设备不匹配时提示"该授权码已在其他设备激活，请联系客服"

**频率限制**：
- 基于用户ID（从JWT Token解析）
- 两次起名请求间隔≥30秒
- 仅限制起名请求，不限制查看历史/收藏

---

## 五、API 设计
### 5.1 认证 API
#### POST `/api/auth/validate` - 验证授权码
**请求：**

```json
{
  "code": "BABY-A3F7-92D1-4E8C",
  "deviceId": "sha256-hash-of-useragent-and-ip"
}
```

**响应（首次激活）：**

```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "recovered": false,
    "message": "激活成功"
  }
}
```

**错误响应：**

```json
{
  "success": false,
  "error": {
    "code": "CODE_FORMAT_INVALID",
    "message": "授权码格式不正确，请检查"
  }
}
```

```json
{
  "success": false,
  "error": {
    "code": "CODE_NOT_FOUND",
    "message": "授权码无效，请确认后重新输入"
  }
}
```

```json
{
  "success": false,
  "error": {
    "code": "CODE_ALREADY_USED",
    "message": "该授权码已被使用，每个授权码仅限激活一次"
  }
}
```

```json
{
  "success": false,
  "error": {
    "code": "CODE_EXPIRED",
    "message": "授权码已过期，请重新购买"
  }
}
```

**限流：** 15 分钟内最多 10 次

---

#### POST `/api/auth/recover` - Token恢复（新增）
**请求：**

```json
{
  "code": "BABY-A3F7-92D1-4E8C",
  "deviceId": "sha256-hash-of-useragent-and-ip"
}
```

**响应（设备匹配）：**

```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "recovered": true,
    "message": "Token恢复成功"
  }
}
```

**错误响应（设备不匹配）：**

```json
{
  "success": false,
  "error": {
    "code": "DEVICE_MISMATCH",
    "message": "该授权码已在其他设备激活，请联系客服"
  }
}
```

**限流：** 15 分钟内最多 10 次

---

#### GET `/api/auth/status` - 获取授权状态
**请求头：**

```plain
Authorization: Bearer <token>
```

**响应：**

```json
{
  "success": true,
  "data": {
    "activated": true,
    "code": "BABY-A3F7-****-****",
    "deviceId": "device-fingerprint",
    "activatedAt": "2025-01-20T10:30:00.000Z"
  }
}
```

---

### 5.2 起名 API
#### POST `/api/name/generate` - AI 生成名字
**请求头：**

```plain
Authorization: Bearer <token>
```

**请求：**

```json
{
  "surname": "李",
  "gender": "male",
  "birthDate": "2025-03-15",
  "birthTime": "08:30",
  "requirements": "希望名字有书卷气"
}
```

**响应：**

```json
{
  "success": true,
  "data": {
    "names": [
      {
        "id": "name-uuid-1",
        "name": "明轩",
        "full_name": "李明轩",
        "pinyin": "Lǐ Míngxuān",
        "meaning": "明亮高远，寓意前程似锦",
        "cultural_source": "《诗经·大雅》",
        "wuxing_analysis": "五行：火木",
        "score": 95,
        "highlight": "书卷气浓厚，音律优美"
      }
    ],
    "generationTime": 1234
  }
}
```

**错误响应（频率限制）：**

```json
{
  "success": false,
  "error": {
    "code": "RATE_LIMIT_EXCEEDED",
    "message": "操作过于频繁，请稍后再试",
    "waitSeconds": 25
  }
}
```

**限流：** 基于用户ID，30秒内最多1次

---

#### GET `/api/name/history` - 获取历史记录
**请求头：**

```plain
Authorization: Bearer <token>
```

**响应：**

```json
{
  "success": true,
  "data": {
    "records": [
      {
        "id": "record-uuid-1",
        "date": "2023-10-27",
        "surname": "陈",
        "gender": "boy",
        "names": ["名字1", "名字2", "名字3", "名字4", "名字5"],
        "createdAt": "2023-10-27T10:30:00.000Z"
      }
    ],
    "total": 15,
    "hasMore": false
  }
}
```

---

### 5.3 收藏 API（新增）
#### GET `/api/favorites` - 获取收藏列表
**请求头：**

```plain
Authorization: Bearer <token>
```

**查询参数：**
- `filter`: `all` | `high` | `new`（筛选条件）

**响应：**

```json
{
  "success": true,
  "data": {
    "favorites": [
      {
        "id": "fav-uuid-1",
        "nameData": {
          "id": "name-uuid-1",
          "name": "泽言",
          "pinyin": "Zé Yán",
          "score": 95,
          "meaning": "恩泽之言，润物无声",
          "createdAt": "2025-01-20T10:00:00.000Z"
        }
      }
    ],
    "total": 8
  }
}
```

---

#### POST `/api/favorites` - 添加收藏
**请求头：**

```plain
Authorization: Bearer <token>
```

**请求：**

```json
{
  "nameData": {
    "id": "name-uuid-1",
    "name": "泽言",
    "full_name": "李泽言",
    "pinyin": "Lǐ Zé Yán",
    "meaning": "恩泽之言，润物无声",
    "cultural_source": "...",
    "wuxing_analysis": "...",
    "score": 95,
    "highlight": "..."
  }
}
```

**响应：**

```json
{
  "success": true,
  "data": {
    "id": "fav-uuid-1",
    "message": "收藏成功"
  }
}
```

---

#### DELETE `/api/favorites/:id` - 删除收藏
**请求头：**

```plain
Authorization: Bearer <token>
```

**响应：**

```json
{
  "success": true,
  "data": {
    "message": "取消收藏成功"
  }
}
```

---

### 5.4 健康检查 API
#### GET `/health` - 服务健康状态
**响应：**

```json
{
  "status": "healthy",
  "timestamp": "2025-01-20T10:30:00.000Z",
  "database": "connected",
  "uptime": 86400
}
```

#### GET `/` - API 信息
**响应：**

```json
{
  "name": "Baby Name API",
  "version": "2.0.0",
  "status": "running",
  "timestamp": "2025-01-20T10:30:00.000Z"
}
```

---

## 六、核心服务详解
### 6.1 认证服务 (AuthService)
**职责：**

+ 授权码格式验证（16位格式：BABY-XXXX-XXXX-XXXX-XXXX）
+ 授权码状态检查（UNUSED/USED/EXPIRED）
+ 未激活授权码90天过期检查
+ 设备绑定验证（首次激活时绑定设备指纹）
+ JWT 令牌生成与验证
+ Token恢复机制（设备指纹匹配）

**激活流程：**

```plain
1. 格式验证 → 正则表达式检查：/^BABY-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/
2. 数据库查询 → codeRepository.findByCode()
3. 过期检查 → 未激活授权码90天过期（createdAt + 90天）
4. 状态检查 → UNUSED（可激活）/USED（走恢复流程）/EXPIRED
5. 设备绑定 → 绑定 deviceId（SHA256 of User-Agent + IP）
6. 状态更新 → status: "USED"，记录activatedAt和activatedIp
7. 生成 JWT → jwtService.generate()，包含userId和deviceId
```

**恢复流程：**

```plain
1. 格式验证 → 正则表达式检查
2. 数据库查询 → codeRepository.findByCode()
3. 状态检查 → 必须为USED
4. 设备匹配 → 对比deviceId与当前设备指纹
5. 匹配成功 → 重新生成JWT，recovered: true
6. 匹配失败 → 返回DEVICE_MISMATCH错误
```

---

### 6.2 起名服务 (NameService)
**职责：**

+ 用户激活状态验证（通过JWT）
+ 频率限制检查（基于用户ID，30秒）
+ 调用智谱 AI 生成名字
+ 记录使用日志（云端存储）
+ 历史记录查询（最多100条）

**流程：**

```plain
1. JWT验证 → 从Token解析userId
2. 频率限制检查 → rateLimitService.checkLimit(userId)
3. 调用 AI 服务 → zhipuService.generateNames()
4. 记录使用日志 → usageRepository.create()
5. 返回结果 → 包含5个名字的完整数据
```

**一客一码机制：**
- 激活后可无限次使用起名功能（无次数限制）
- 仅通过频率限制防止滥用

---

### 6.3 收藏服务 (FavoriteService) - 新增
**职责：**

+ 收藏增删查
+ 云端同步（多设备一致性）
+ 冲突处理（按最新修改时间合并）
+ 防止重复收藏

**添加收藏流程：**

```plain
1. 验证JWT → 获取userId
2. 检查是否已存在 → @@unique([userId, nameId])
3. 创建收藏记录 → favoriteRepository.create()
4. 返回结果
```

**获取收藏流程：**

```plain
1. 验证JWT → 获取userId
2. 根据filter筛选 → all/high/new
3. 返回收藏列表 → 按createdAt降序
```

**收藏数量上限：**
- 单用户最多收藏100个名字

---

### 6.4 频率限制服务 (RateLimitService) - 新增
**职责：**

+ 基于用户ID的频率控制
+ 30秒内最多1次起名请求
+ 返回剩余等待时间

**实现方式：**

```typescript
class RateLimitService {
  private redis: Redis;

  async checkLimit(userId: string): Promise<{ allowed: boolean; waitSeconds: number }> {
    const key = `ratelimit:name:${userId}`;
    const lastRequest = await this.redis.get(key);

    if (lastRequest) {
      const elapsed = Date.now() - parseInt(lastRequest);
      if (elapsed < 30000) {  // 30秒
        return { allowed: false, waitSeconds: Math.ceil((30000 - elapsed) / 1000) };
      }
    }

    await this.redis.set(key, Date.now(), 'EX', 30);
    return { allowed: true, waitSeconds: 0 };
  }
}
```

**限制范围：**
- 仅限制起名请求
- 不限制查看历史/收藏

---

### 6.5 智谱 AI 服务 (ZhipuService)
**配置：**

+ **模型：** GLM-4.7（最新版本）
+ **API 地址：** `https://open.bigmodel.cn/api/paas/v4/chat/completions`
+ **超时时间：** 30 秒

**Prompt 设计：**

+ 角色设定：20 年经验起名大师
+ 输入：姓氏、性别、出生日期/时间、特殊要求
+ 输出：5 个精选名字（JSON 格式）
+ 标准：寓意、音律、字形、文化、时代感、避免生僻

**错误处理：**

| HTTP 状态 | 错误类型 | 用户提示 |
| --- | --- | --- |
| 401 | 认证失败 | AI 服务认证失败 |
| 429 | 请求过多 | AI 服务请求过于频繁 |
| 超时 | ECONNABORTED | AI 服务响应超时 |
| 其他 | - | AI 服务暂时不可用 |


---

## 七、中间件设计
### 7.1 安全中间件
| 中间件 | 作用 |
| --- | --- |
| **Helmet** | 安全头部（CSP、HSTS、X-Frame-Options） |
| **CORS** | 跨域控制（仅允许指定前端域名） |
| **Compression** | 响应压缩（>1KB 启用） |


### 7.2 认证中间件
| 中间件 | 作用 |
| --- | --- |
| **authenticate** | JWT 验证，必需认证 |
| **optionalAuth** | JWT 验证，可选认证 |


### 7.3 验证中间件
使用 Zod Schema 验证：

+ `validateCodeSchema`：授权码格式（BABY-XXXX-XXXX-XXXX-XXXX）
+ `validateNameSchema`：起名参数格式
+ `validateFavoriteSchema`：收藏数据格式

### 7.4 限流中间件
| 限流器 | 时间窗口 | 最大次数 | 应用范围 |
| --- | --- | --- | --- |
| **apiLimiter** | 15 分钟 | 100 | 全局 API |
| **nameGenerateLimiter** | 基于用户ID | 30秒1次 | 起名接口（通过RateLimitService） |
| **authLimiter** | 15 分钟 | 10 | 授权码验证/恢复 |

**注意：** 起名接口的限流通过RateLimitService实现，基于用户ID和Redis存储，而非传统的IP限流。


### 7.5 错误处理中间件
**错误码定义：**

| 错误码 | 说明 | HTTP状态码 |
| --- | --- | --- |
| `CODE_FORMAT_INVALID` | 授权码格式不正确 | 400 |
| `CODE_NOT_FOUND` | 授权码不存在 | 404 |
| `CODE_ALREADY_USED` | 授权码已被使用 | 400 |
| `CODE_EXPIRED` | 授权码已过期 | 400 |
| `DEVICE_MISMATCH` | 设备不匹配 | 403 |
| `RATE_LIMIT_EXCEEDED` | 频率限制超限 | 429 |
| `INVALID_TOKEN` | Token无效或过期 | 401 |
| `DATABASE_ERROR` | 数据库错误 | 500 |

**响应格式：**

```json
{
  "success": false,
  "error": {
    "code": "ERROR_CODE",
    "message": "错误描述",
    "waitSeconds": 25  // 可选，仅频率限制时返回
  }
}
```


---

## 八、日志系统
### 8.1 日志级别
| 级别 | 值 | 用途 |
| --- | --- | --- |
| **error** | 0 | 错误日志 |
| **warn** | 1 | 警告日志 |
| **info** | 2 | 信息日志 |
| **http** | 3 | HTTP 请求日志 |
| **debug** | 4 | 调试日志 |


### 8.2 日志输出
| 环境 | 输出目标 |
| --- | --- |
| **开发** | 控制台（彩色）+ 文件 |
| **生产** | 仅文件 |


### 8.3 日志文件
| 文件 | 内容 |
| --- | --- |
| `logs/error.log` | 错误日志（5MB 轮转，保留 5 个） |
| `logs/combined.log` | 全部日志（5MB 轮转，保留 5 个） |


---

## 九、Supabase 配置信息
### 9.1 连接配置
| 配置项 | 值 |
| --- | --- |
| **项目 ID** | `puzbruleuezupsfxpusm` |
| **数据库用户** | `postgres` |
| **密码** | `zw15827455010` |
| **区域** | `aws-0-us-east-1` |


### 9.2 连接字符串
**Transaction Pooler** (应用连接，端口 6543):

```plain
postgresql://postgres.puzbruleuezupsfxpusm:zw15827455010@aws-0-us-east-1.pooler.supabase.com:6543/postgres?pgbouncer=true&connect_timeout=30
```

**Session Pooler** (数据库迁移，端口 5432):

```plain
postgresql://postgres.puzbruleuezupsfxpusm:zw15827455010@aws-0-us-east-1.pooler.supabase.com:5432/postgres?connect_timeout=30
```

### 9.3 环境变量
```bash
# 数据库配置
DATABASE_URL="postgresql://..."
DIRECT_URL="postgresql://..."

# JWT 配置
JWT_SECRET="baby-name-secret-key-2025-dev-only"
JWT_EXPIRES_IN="90d"

# 智谱 AI 配置
ZHIPU_API_KEY="8575b70553914ca8825ba725705a95f3.UxKbhgnTpZkZTNy6"
ZHIPU_API_URL="https://open.bigmodel.cn/api/paas/v4/chat/completions"

# 前端地址
FRONTEND_URL="http://localhost:5178"

# 限流配置
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX=100
```

### 9.4 Supabase 管理入口
+ **项目控制台：** `https://supabase.com/dashboard/project/puzbruleuezupsfxpusm`
+ **数据库查看：** Supabase Dashboard → Table Editor
+ **SQL 查询：** Supabase Dashboard → SQL Editor

---

## 十、部署与运维
### 10.1 本地开发
```bash
# 安装依赖
npm install

# 生成 Prisma 客户端
npm run prisma:generate

# 运行数据库迁移
npm run prisma:migrate

# 启动开发服务器
npm run dev
```

### 10.2 生产构建
```bash
# 编译 TypeScript
npm run build

# 启动生产服务器
npm start
```

### 10.3 数据库操作
```bash
# 生成迁移文件
npx prisma migrate dev --name <migration-name>

# 应用迁移
npx prisma migrate deploy

# 打开 Prisma Studio（数据库 GUI）
npm run prisma:studio

# 重置数据库（谨慎使用）
npx prisma migrate reset
```

### 10.4 优雅关闭
服务器监听系统信号，执行优雅关闭流程：

1. 停止接收新请求
2. 等待现有请求完成（最多 10 秒）
3. 关闭数据库连接
4. 退出进程

```typescript
process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));
process.on('SIGINT', () => gracefulShutdown('SIGINT'));
```

---

## 十一、安全建议
1. **敏感信息保护**
    - `.env` 文件已添加到 `.gitignore`
    - 生产环境使用强密钥
    - 定期轮换 API 密钥
2. **传输安全**
    - 生产环境强制 HTTPS
    - 启用 HSTS 预加载
    - 配置 CSP 策略
3. **认证安全**
    - JWT 令牌有效期 90 天
    - 使用 bcrypt 加密管理员密码
    - 实现请求限流防护
4. **数据安全**
    - 敏感数据脱敏（日志中）
    - SQL 注入防护（Prisma ORM）
    - XSS 防护（Helmet）

---

## 十二、故障排查
### 12.1 常见问题
| 问题 | 可能原因 | 解决方案 |
| --- | --- | --- |
| 数据库连接失败 | Supabase 凭据错误 | 检查 `.env` 中的 `DATABASE_URL` |
| AI 服务超时 | 网络问题 / API 过载 | 增加超时时间或重试 |
| JWT 验证失败 | 令牌过期 / 密钥不匹配 | 重新登录或检查 `JWT_SECRET` |
| 限流触发过多 | 单一设备请求过多 | 调整 `RATE_LIMIT_MAX` |


### 12.2 日志查看
```bash
# 实时查看错误日志
tail -f backend/logs/error.log

# 查看全部日志
tail -f backend/logs/combined.log

# 搜索特定错误
grep "ERROR" backend/logs/combined.log
```

---

## 附录
### A. 项目依赖清单
见 `package.json`

### B. TypeScript 配置
见 `tsconfig.json`

### C. Prisma Schema
见 `prisma/schema.prisma`

### D. 错误码清单
见 **第七章 - 中间件设计 - 7.5 错误处理中间件**

### E. API 接口汇总
| 方法 | 路径 | 说明 | 优先级 |
|------|------|------|--------|
| POST | `/api/auth/validate` | 验证授权码 | P0 |
| POST | `/api/auth/recover` | 恢复Token | P0 |
| GET | `/api/auth/status` | 获取授权状态 | P1 |
| POST | `/api/name/generate` | AI生成名字 | P0 |
| GET | `/api/name/history` | 获取历史记录 | P1 |
| GET | `/api/favorites` | 获取收藏列表 | P1 |
| POST | `/api/favorites` | 添加收藏 | P1 |
| DELETE | `/api/favorites/:id` | 删除收藏 | P1 |
| GET | `/health` | 健康检查 | P2 |

### F. 设备指纹生成
```typescript
// utils/device-fingerprint.ts
import * as crypto from 'crypto';

export function generateDeviceFingerprint(
  userAgent: string,
  ip: string
): string {
  const hash = crypto
    .createHash('sha256')
    .update(`${userAgent}-${ip}`)
    .digest('hex')
    .substring(0, 32);
  return hash;
}
```

---

## 变更记录

### v2.0.0 (2026-01-23)
**重大更新：**
- [修复] 授权码格式从19位改为16位（BABY-XXXX-XXXX-XXXX-XXXX）
- [修复] 一客一码机制：移除usageCount/maxUsage，激活后无限次使用
- [新增] Token恢复API（/api/auth/recover），支持设备指纹匹配
- [修复] 频率限制改为基于用户ID，30秒间隔，仅限制起名请求
- [新增] 收藏云端同步API（GET/POST/DELETE /api/favorites）
- [优化] 历史记录API响应结构，匹配前端需求
- [新增] Favorite数据模型（云端收藏）
- [新增] RateLimitService（基于Redis的用户级限流）
- [优化] 错误码定义和响应格式统一
- [新增] 设备指纹生成工具函数

### v1.0.0 (2025-01-20)
- 初始版本

---

**文档版本：** v2.0.0
**最后更新：** 2026-01-23
**更新内容：** 修复授权码格式、一客一码机制、Token恢复、频率限制、收藏同步

